suite: test deployment
templates:
  - deployment.yaml
  - rbac.yaml
  - test-secret.yaml
tests:
  - it: should create a deployment with correct replicas
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.replicas
          value: 1

  - it: should use correct image
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
      image.repository: 'custom-repo'
      image.tag: 'v1.0.0'
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: 'custom-repo:v1.0.0'

  - it: should reference token secret via env var
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
      cloudControllerManager.secret.key: 'api-token'
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: BINARYLANE_API_TOKEN
            valueFrom:
              secretKeyRef:
                name: binarylane-api-token
                key: api-token

  - it: should use correct service account
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
      serviceAccount.name: 'custom-sa'
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: 'custom-sa'

  - it: should apply tolerations
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: node-role.kubernetes.io/control-plane
            operator: Exists
            effect: NoSchedule

  - it: should apply node selector
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            node-role.kubernetes.io/control-plane: ''

  - it: should use host network
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - equal:
          path: spec.template.spec.hostNetwork
          value: true

  - it: should set dnsPolicy for hostNetwork pods
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - equal:
          path: spec.template.spec.dnsPolicy
          value: Default

  - it: should have security context
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false

  - it: should create RBAC resources
    template: rbac.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: ClusterRole
        documentIndex: 0
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 1

  - it: should allow TokenRequest and configmap reads
    template: rbac.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
    asserts:
      - contains:
          path: rules
          content:
            apiGroups:
              - ''
            resources:
              - serviceaccounts/token
            verbs:
              - create
        documentIndex: 0
      - contains:
          path: rules
          content:
            apiGroups:
              - ''
            resources:
              - configmaps
            verbs:
              - get
              - list
              - watch
        documentIndex: 0

  - it: should apply extra args
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
      extraArgs:
        - '--kube-api-qps=50'
        - '--kube-api-burst=100'
    asserts:
      - contains:
          path: spec.template.spec.containers[0].command
          content: '--kube-api-qps=50'
      - contains:
          path: spec.template.spec.containers[0].command
          content: '--kube-api-burst=100'

  - it: should create test secret when enabled
    template: test-secret.yaml
    set:
      createTestSecret: true
      cloudControllerManager.secret.name: 'binarylane-api-token'
      cloudControllerManager.secret.key: 'api-token'
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.api-token
          value: 'test-token-for-ci'

  - it: should set resource limits
    template: deployment.yaml
    set:
      cloudControllerManager.secret.name: 'binarylane-api-token'
      resources:
        limits:
          cpu: '500m'
          memory: '256Mi'
        requests:
          cpu: '200m'
          memory: '128Mi'
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: '500m'
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: '200m'
